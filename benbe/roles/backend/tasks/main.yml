---
- name: Ensure git is installed
  apt:
    name: git
    state: present
  become: true

- name: Ensure python3-pip is installed
  apt:
    name: python3-pip
    state: present
  become: true

- name: Ensure python3-venv is installed
  apt:
    name: python3-venv
    state: present
  become: true

- name: Clone backend repo
  git:
    repo: "{{ backend_repo }}"
    dest: /opt/fruits-veg_market
    version: main
    force: yes

- name: Create Python virtual environment
  command: python3 -m venv "{{ backend_path }}/venv"
  args:
    creates: "{{ backend_path }}/venv/bin/activate"

- name: Install Python requirements
  pip:
    requirements: "{{ backend_path }}/requirements.txt"
    virtualenv: "{{ backend_path }}/venv"

- name: Ensure uvicorn is installed in venv
  pip:
    name: uvicorn
    virtualenv: "{{ backend_path }}/venv"

- name: Run backend with FastAPI (uvicorn)
  shell: |
    nohup {{ backend_path }}/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
  args:
    chdir: "{{ backend_path }}"
  async: 0
  poll: 0
